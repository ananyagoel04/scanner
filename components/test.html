<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner.js Demo with URL and Scan Options</title>
    <style>
        #images {
            margin-top: 20px;
        }

        .scanned {
            margin: 10px;
            max-width: 100%;
            max-height: 300px;
        }
    </style>
</head>

<body>
    <h1>Upload Image - Scan or From URL</h1>

    <!-- Option to scan an image -->

    <button type="button" onclick="scanAndSend();">Scan and Send to Extension</button>

    <!-- Option to upload a file from URL -->
    <button type="button" onclick="uploadImageFromUrl();">Upload Image from URL</button>

    <!-- Container to display scanned images -->
    <div id="images"></div>

    <!-- Include the scanner.js library -->
    <script type="text/javascript" src="https://cdn.asprise.com/scannerjs/scanner.js"></script>

    <script>
        function scanAndSend() {
            scanner.scan(displayImagesOnPage, {
                "output_settings": [
                    {
                        "type": "return-base64",
                        "format": "jpg"
                    }
                ]
            });
        }

        function displayImagesOnPage(successful, mesg, response) {
            if (!successful) {
                console.error('Failed: ' + mesg);
                return;
            }

            if (successful && mesg != null && mesg.toLowerCase().indexOf('user cancel') >= 0) {
                console.info('User canceled');
                return;
            }

            var scannedImages = scanner.getScannedImages(response, true, false);

            for (var i = 0; i < scannedImages.length; i++) {
                var scannedImage = scannedImages[i];
                processScannedImage(scannedImage);

                sendImageToServer(scannedImage);
            }
        }

        function processScannedImage(scannedImage) {
            var elementImg = createDomElementFromModel({
                'name': 'img',
                'attributes': {
                    'class': 'scanned',
                    'src': scannedImage.src
                }
            });

            document.getElementById('images').appendChild(elementImg);
        }

        function createDomElementFromModel(model) {
            var element = document.createElement(model.name);
            for (var attr in model.attributes) {
                element.setAttribute(attr, model.attributes[attr]);
            }
            return element;
        }

        function sendImageToServer(scannedImage) {
            var imageData = scannedImage.src.split(',')[1];

            var postData = {
                image: imageData,
                mimeType: 'image/jpeg',
                fileName: 'scanned_image.jpg'
            };

            fetch('https://extention-server.vercel.app/uploadImage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(postData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log('Image uploaded successfully');
                        sendToExtension(data);
                    } else {
                        console.error('Failed to upload image:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error uploading image:', error);
                });
        }
        function sendToExtension(data) {
            chrome.runtime.sendMessage({
                action: 'storeImage',
                image: data
            });
        }

        function uploadImageFromUrl() {
            var imageUrl = prompt("Please enter the image URL:");

            if (!imageUrl) {
                alert("No URL provided!");
                return;
            }

            fetch(imageUrl)
                .then(response => response.blob())
                .then(blob => {
                    var reader = new FileReader();
                    reader.onloadend = function () {
                        var base64Image = reader.result.split(',')[1];
                        var postData = {
                            image: base64Image,
                            mimeType: blob.type,
                            fileName: imageUrl.split('/').pop()
                        };

                        fetch('https://extention-server.vercel.app/uploadImage', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(postData)
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    console.log('Image uploaded successfully from URL');
                                    alert('Image uploaded successfully!');
                                    sendToExtension(data);
                                } else {
                                    console.error('Failed to upload image:', data.message);
                                }
                            })
                            .catch(error => {
                                console.error('Error uploading image:', error);
                            });
                    };
                    reader.readAsDataURL(blob);
                })
                .catch(error => {
                    console.error("Failed to fetch the image from URL", error);
                });
        }
    </script>
</body>

</html>